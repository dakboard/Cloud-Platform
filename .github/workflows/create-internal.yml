name: Create Internal Issue

on:
  issues:
    types: [opened]

jobs:
  create_internal_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Create issue in dakboard/Internal
        id: create_internal
        run: |
          HTTP_STATUS=$(curl -sS -o response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/dakboard/Internal/issues \
            -d "{\"title\":\"CP#${{ github.event.issue.number }} â€” ${{ github.event.issue.title }}\",\"body\":\"Cloud-Platform issue: ${{ github.event.issue.html_url }}\n\nCustomer reported:\n\n${{ github.event.issue.body }}\"}" \
          )

          echo "HTTP_STATUS=$HTTP_STATUS"
          echo "API response:"
          cat response.json

          if [ "$HTTP_STATUS" -ne 201 ]; then
            echo "Failed to create internal issue (status $HTTP_STATUS)"
            exit 1
          fi

          INTERNAL_NUMBER=$(jq '.number' response.json)
          echo "internal_number=$INTERNAL_NUMBER" >> "$GITHUB_OUTPUT"

      # No public comment included
