name: Create Internal Issue

on:
  issues:
    types: [opened]

jobs:
  create_internal_issue:
    runs-on: [ubuntu-latest, CP-Internal]

    steps:
      - name: Create issue in dakboard/Internal (no external actions)
        id: create_internal
        run: |
          RESPONSE=$(curl -X POST \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/dakboard/Internal/issues \
            -d @- << EOF
          {
            "title": "CP#${{ github.event.issue.number }} â€” ${{ github.event.issue.title }}",
            "body": "A customer reported the following:\n\n${{ github.event.issue.body }}\n\nCloud-Platform Issue URL: ${{ github.event.issue.html_url }}"
          }
            EOF
          )

          echo "$RESPONSE" > response.json
          INTERNAL_NUMBER=$(jq '.number' response.json)
          echo "internal_number=$INTERNAL_NUMBER" >> $GITHUB_OUTPUT

      - name: Comment backlink in Cloud-Platform
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/dakboard/Cloud-Platform/issues/${{ github.event.issue.number }}/comments \
            -d "{\"body\": \"Internal tracking issue created: https://github.com/dakboard/Internal/issues/${{ steps.create_internal.outputs.internal_number }}\"}"
