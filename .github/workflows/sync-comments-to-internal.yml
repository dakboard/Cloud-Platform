name: Sync CP comments to Internal

on:
  issue_comment:
    types: [created]

jobs:
  sync_comment:
    runs-on: ubuntu-latest

    steps:
      - name: Handle new comment
        run: |
          # Skip bot comments
          if [ "${{ github.event.comment.user.type }}" = "Bot" ]; then
            echo "Skipping bot comment"
            exit 0
          fi

          CP_NUMBER="${{ github.event.issue.number }}"
          TITLE_PREFIX="CP#${CP_NUMBER} â€”"

          # Find internal issue with matching title prefix
          RESP=$(curl -sS \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Internal/issues?state=all&per_page=100")

          INTERNAL_NUMBER=$(echo "$RESP" | jq -r ".[] | select(.title | startswith(\"${TITLE_PREFIX}\")) | .number" | head -n 1)

          if [ -z "$INTERNAL_NUMBER" ] || [ "$INTERNAL_NUMBER" = "null" ]; then
            echo "Internal issue not found"
            exit 0
          fi

          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          COMMENT_URL="https://github.com/dakboard/Cloud-Platform/issues/${CP_NUMBER}#issuecomment-${{ github.event.comment.id }}"

          # Build nicely formatted Markdown comment with real newlines
          FINAL_BODY=$(cat <<EOF
**Comment from @${COMMENT_AUTHOR} on Cloud-Platform issue #${CP_NUMBER}:**

${{ github.event.comment.body }}

---
[View original comment](${COMMENT_URL})
EOF
          )

          # Post into Internal issue
          curl -sS -X POST \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Internal/issues/${INTERNAL_NUMBER}/comments" \
            -d "$(jq -n --arg body "$FINAL_BODY" '{body: $body}')"
