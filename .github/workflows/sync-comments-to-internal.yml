name: Sync CP comments to Internal

on:
  issue_comment:
    types: [created]

jobs:
  sync_comment:
    runs-on: ubuntu-latest

    steps:
      - name: Mirror comment into Internal issue
        run: |
          # Skip bot comments to avoid loops
          if [ "${{ github.event.comment.user.type }}" = "Bot" ]; then
            echo "Skipping bot comment"
            exit 0
          fi

          CP_NUMBER="${{ github.event.issue.number }}"
          TITLE_PREFIX="CP#${CP_NUMBER} â€”"

          echo "Looking for Internal issue matching prefix: $TITLE_PREFIX"

          # Fetch Internal issues and find matching one by title prefix
          RESP=$(curl -sS \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Internal/issues?state=all&per_page=100")

          INTERNAL_NUMBER=$(echo "$RESP" | jq -r ".[] | select(.title | startswith(\"${TITLE_PREFIX}\")) | .number" | head -n 1)

          if [ -z "$INTERNAL_NUMBER" ] || [ "$INTERNAL_NUMBER" = "null" ]; then
            echo "No matching Internal issue found"
            exit 0
          fi

          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          COMMENT_URL="https://github.com/dakboard/Cloud-Platform/issues/${CP_NUMBER}#issuecomment-${{ github.event.comment.id }}"

          # Build a nicely formatted Markdown body using jq (handles newlines safely)
          JSON_PAYLOAD=$(jq -n \
            --arg author "$COMMENT_AUTHOR" \
            --arg cpnum "$CP_NUMBER" \
            --arg body "${{ github.event.comment.body }}" \
            --arg url "$COMMENT_URL" \
            '{body: "**Comment from @"+$author+" on Cloud-Platform issue #"+$cpnum+":**\n\n"+$body+"\n\n---\n[View original comment]("+$url+")"}')

          echo "Posting comment to Internal issue #$INTERNAL_NUMBER"

          curl -sS -X POST \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Internal/issues/${INTERNAL_NUMBER}/comments" \
            -d "$JSON_PAYLOAD"
