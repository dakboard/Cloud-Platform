name: Sync CP comments to Internal

on:
  issue_comment:
    types: [created]

jobs:
  sync_comment:
    runs-on: ubuntu-latest

    steps:
      - name: Handle new comment
        run: |
          # Skip bot comments (prevents loops)
          if [ "${{ github.event.comment.user.type }}" = "Bot" ]; then
            echo "Skipping bot comment"
            exit 0
          fi

          CP_NUMBER="${{ github.event.issue.number }}"
          TITLE_PREFIX="CP#${CP_NUMBER} â€”"

          echo "Looking for Internal issue matching prefix: $TITLE_PREFIX"

          # Fetch all Internal issues and find matching one by title
          RESP=$(curl -sS \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Internal/issues?state=all&per_page=100")

          INTERNAL_NUMBER=$(echo "$RESP" | jq -r ".[] | select(.title | startswith(\"${TITLE_PREFIX}\")) | .number" | head -n 1)

          if [ -z "$INTERNAL_NUMBER" ] || [ "$INTERNAL_NUMBER" = "null" ]; then
            echo "No matching internal issue found."
            exit 0
          fi

          echo "Found internal issue: #$INTERNAL_NUMBER"

          # Prepare full comment body (escape newlines and quotes for JSON)
          COMMENT_BODY=$(jq -Rs <<< "${{ github.event.comment.body }}" | sed 's/"/\\"/g')
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          COMMENT_URL="https://github.com/dakboard/Cloud-Platform/issues/${CP_NUMBER}#issuecomment-${{ github.event.comment.id }}"

          FINAL_BODY="**Comment from @${COMMENT_AUTHOR} on Cloud-Platform issue #${CP_NUMBER}:**\n\n${{ github.event.comment.body }}\n\n---\n[View original comment](${COMMENT_URL})"

          # Post full comment into Internal issue
          curl -sS -X POST \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Internal/issues/${INTERNAL_NUMBER}/comments" \
            -d "$(jq -n --arg body "$FINAL_BODY" '{body: $body}')"
